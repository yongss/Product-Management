<!DOCTYPE html>
<html>

<head>
    <title>Modify Product</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .file-card-clickable {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .file-card-clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #f0f8ff;
        }

        .btn-open-file {
            display: inline-block;
            padding: 6px 12px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            border: none;
            margin-right: 5px;
        }

        .btn-open-file:hover {
            background-color: #218838;
        }

        .inline-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Modify Product</h1>

        <!-- Open form BEFORE form-actions -->
        <form id="modifyForm" action="/update" method="POST" enctype="multipart/form-data">

            <!-- Sticky action buttons now live INSIDE the form -->
            <div class="form-actions">
                <button type="submit" class="btn-update">Update Product</button>
                <a href="/" class="btn-cancel">Cancel</a>
            </div>

            <input type="hidden" name="id" value="{{.ID}}">
            <input type="hidden" name="existingPhotos" id="existingPhotos" value="{{.Photos}}">
            <input type="hidden" name="existingDrawings" id="existingDrawings" value="{{.Drawing2D}}">
            <input type="hidden" name="existingCad" id="existingCad" value="{{.Cad3D}}">
            <input type="hidden" name="existingCnc" id="existingCnc" value="{{.CncCode}}">
            <input type="hidden" name="existingInvoice" id="existingInvoice" value="{{.Invoice}}">

            <input type="hidden" name="photosAction" id="photosAction" value="keepBoth">
            <input type="hidden" name="drawingsAction" id="drawingsAction" value="keepBoth">
            <input type="hidden" name="cadAction" id="cadAction" value="keepBoth">
            <input type="hidden" name="cncAction" id="cncAction" value="keepBoth">
            <input type="hidden" name="invoiceAction" id="invoiceAction" value="keepBoth">

            <br>
            <div class="form-group">
                <label class="label">Part No:</label>
                <input type="text" name="partNo" value="{{.PartNo}}" required>
            </div>

            <div class="form-group">
                <label class="label">Part Name:</label>
                <input type="text" name="partName" value="{{.PartName}}">
            </div>

            <div class="form-group">
                <label class="label">Description:</label>
                <textarea name="description">{{.Description}}</textarea>
            </div>

            <div class="form-group">
                <label class="label">Material:</label>
                <input type="text" name="material" value="{{.Material}}">
            </div>
            <div class="form-group">
                <label class="label">Material Size/Dimensions:</label>
                <input type="text" name="materialSize" value="{{.MaterialSize}}">
            </div>
            <div class="form-group">
                <label class="label">Material Cost ($):</label>
                <input type="text" name="materialCost" value="{{.MaterialCost}}">
            </div>
            <div class="form-group">
                <label class="label">Finishing Type:</label>
                <input type="text" name="finishingType" value="{{.FinishingType}}">
            </div>
            <div class="form-group">
                <label class="label">Finishing Cost ($):</label>
                <input type="text" name="finishingCost" value="{{.FinishingCost}}">
            </div>

            <div class="form-group">
                <label class="label">Part Cost:</label>
                <input type="number" name="cost" value="{{.Cost}}">
            </div>

            <div class="form-group">
                <label class="label">Quantity:</label>
                <input type="number" name="qty" value="{{.Qty}}" required>
            </div>

            <!-- ============================= FILE GROUPS (Photos, Drawings, CAD, CNC, Invoice) ============================= -->
            <div class="file-group">
                <h2>Current Photos:</h2>
                <div id="currentPhotos" class="files-grid">
                    {{if hasFiles .Photos.String}}
                    {{$photos := parseJSON .Photos.String}}
                    {{range $index, $photo := $photos}}
                    <div class="file-item file-card" data-filename="{{$photo.Name}}">
                        <img src="/uploads/{{$photo.Path}}" alt="{{$photo.Name}}" class="thumb"
                            onclick="showPreview(this)">
                        <div>
                            <div class="file-name">{{$photo.Name}}</div>
                            <div class="file-size" style="padding-left:0;">
                                {{$photo.Size}}
                                {{if $photo.Date}}
                                <br><span class="file-date">{{$photo.Date}}</span>
                                {{else}}
                                {{with fileModDate $photo.Path}}<br><span class="file-date">{{.}}</span>{{end}}
                                {{end}}
                            </div>
                        </div>
                        <div class="inline-actions">
                            <!-- <button type="button" class="btn-open-file" onclick="openFileDirectly('{{$photo.Path}}')">ðŸ”— Open</button> -->
                            <button type="button" class="btn-remove btn-small"
                                onclick="removeFile(this, '{{$photo.Name}}', 'photos')">Remove</button>
                        </div>
                    </div>
                    {{end}}
                    {{else}}
                    <p>No photos uploaded</p>
                    {{end}}
                </div>
                <br>
                <label class="label">Add New Photos (JPG/PNG):</label>
                <div class="file-item">
                    <input type="file" name="photos" multiple accept=".jpg,.jpeg,.png,.gif" id="photoInput">
                </div>
                <div class="paste-area" id="pasteArea">
                    Click or paste images here
                    <small>(You can also paste from clipboard)</small>
                </div>
                <div class="preview-container" id="previewContainer"></div>
            </div>

            <!-- 2D Drawings -->
            <div class="file-group">
                <h2>Current 2D Drawings:</h2>
                <div id="currentDrawings" class="files-grid">
                    {{if hasFiles .Drawing2D.String}}
                    {{$drawings := parseJSON .Drawing2D.String}}
                    {{range $index, $drawing := $drawings}}
                    <div class="file-item file-card file-card-clickable" data-filename="{{$drawing.Name}}"
                        onclick="openFileDirectly('{{$drawing.Path}}')">
                        <div>
                            <div class="file-name">{{$drawing.Name}}</div>
                            <div class="file-size">
                                {{$drawing.Size}}
                                {{if $drawing.Date}}
                                <br><span class="file-date">{{$drawing.Date}}</span>
                                {{else}}
                                {{with fileModDate $drawing.Path}}<br><span class="file-date">{{.}}</span>{{end}}
                                {{end}}
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button type="button" class="btn-remove btn-small"
                                onclick="event.stopPropagation(); removeFile(this, '{{$drawing.Name}}', 'drawings')">Remove</button>
                        </div>
                    </div>
                    {{end}}
                    {{else}}
                    <p>No drawings uploaded</p>
                    {{end}}
                </div>
                <br>
                <label class="label">Add New 2D Drawing (PDF/DXF/DWG):</label>
                <div class="file-item">
                    <input type="file" name="drawings" multiple accept=".pdf,.dxf,.dwg">
                </div>
            </div>

            <!-- 3D CAD -->
            <div class="file-group">
                <h2>Current 3D CAD Files:</h2>
                <div id="currentCad" class="files-grid">
                    {{if hasFiles .Cad3D.String}}
                    {{$cad := parseJSON .Cad3D.String}}
                    {{range $index, $cadFile := $cad}}
                    <div class="file-item file-card file-card-clickable" data-filename="{{$cadFile.Name}}"
                        onclick="openFileDirectly('{{$cadFile.Path}}')">
                        <div>
                            <div class="file-name">{{$cadFile.Name}}</div>
                            <div class="file-size">
                                {{$cadFile.Size}}
                                {{if $cadFile.Date}}
                                <br><span class="file-date">{{$cadFile.Date}}</span>
                                {{else}}
                                {{with fileModDate $cadFile.Path}}<br><span class="file-date">{{.}}</span>{{end}}
                                {{end}}
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button type="button" class="btn-remove btn-small"
                                onclick="event.stopPropagation(); removeFile(this, '{{$cadFile.Name}}', 'cad')">Remove</button>
                        </div>
                    </div>
                    {{end}}
                    {{else}}
                    <p>No CAD files uploaded</p>
                    {{end}}
                </div>
                <br>
                <label class="label">Add New 3D CAD Files :</label>
                <div class="file-item">
                    <input type="file" name="cad" multiple
                        accept=".stp,.step,.igs,.iges,.sat,.x_t,.x_b,.sldprt,.sldasm,.ipt,.iam,.prt,.asm">
                </div>
            </div>

            <!-- CNC -->
            <div class="file-group">
                <h2>Current CNC Code Files:</h2>
                <div id="currentCnc" class="files-grid">
                    {{if hasFiles .CncCode.String}}
                    {{$cnc := parseJSON .CncCode.String}}
                    {{range $index, $cncFile := $cnc}}
                    <div class="file-item file-card file-card-clickable" data-filename="{{$cncFile.Name}}"
                        onclick="openFileDirectly('{{$cncFile.Path}}')">
                        <div>
                            <div class="file-name">{{$cncFile.Name}}</div>
                            <div class="file-size">
                                {{$cncFile.Size}}
                                {{if $cncFile.Date}}
                                <br><span class="file-date">{{$cncFile.Date}}</span>
                                {{else}}
                                {{with fileModDate $cncFile.Path}}<br><span class="file-date">{{.}}</span>{{end}}
                                {{end}}
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button type="button" class="btn-remove btn-small"
                                onclick="event.stopPropagation(); removeFile(this, '{{$cncFile.Name}}', 'cnc')">Remove</button>
                        </div>
                    </div>
                    {{end}}
                    {{else}}
                    <p>No CNC code files uploaded</p>
                    {{end}}
                </div>
                <br>
                <label class="label">Add New CNC Code Files :</label>
                <div class="file-item">
                    <input type="file" name="cnc" multiple
                        accept=".mc9,.nc,.tap,.mpf,.spf,.mcam,.mcx,.mcx-5,.mcx-6,.mmd,.pst">
                </div>
            </div>

            <!-- Invoice -->
            <div class="file-group">
                <h2>Current Invoice Files:</h2>
                <div id="currentInvoice" class="files-grid">
                    {{if hasFiles .Invoice.String}}
                    {{$invoice := parseJSON .Invoice.String}}
                    {{range $index, $invoiceFile := $invoice}}
                    <div class="file-item file-card file-card-clickable" data-filename="{{$invoiceFile.Name}}"
                        onclick="openFileDirectly('{{$invoiceFile.Path}}')">
                        <div>
                            <div class="file-name">{{$invoiceFile.Name}}</div>
                            <div class="file-size">
                                {{$invoiceFile.Size}}
                                {{if $invoiceFile.Date}}
                                <br><span class="file-date">{{$invoiceFile.Date}}</span>
                                {{else}}
                                {{with fileModDate $invoiceFile.Path}}<br><span class="file-date">{{.}}</span>{{end}}
                                {{end}}
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button type="button" class="btn-remove btn-small"
                                onclick="event.stopPropagation(); removeFile(this, '{{$invoiceFile.Name}}', 'invoice')">Remove</button>
                        </div>
                    </div>
                    {{end}}
                    {{else}}
                    <p>No invoice files uploaded</p>
                    {{end}}
                </div>
                <br>
                <label class="label">Add New Invoice Files (PDF):</label>
                <div class="file-item">
                    <input type="file" name="invoice" multiple
                        accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.rtf,.odt,.ods,.odp">
                </div>
            </div>

            <!-- Metadata -->
            <div class="form-group">
                <label class="label">Created At:</label>
                <div class="file-info">{{.CreatedAt}}</div>
            </div>

            <div class="form-group">
                <label class="label">Last Updated:</label>
                <div class="file-info">{{.UpdatedAt}}</div>
            </div>
        </form>
    </div>

    <div id="preview" class="preview" style="display: none;">
        <span class="close-btn" onclick="hidePreview()">&times;</span>
        <img id="previewImg" src="" alt="Preview">
    </div>

    <script src="/static/js/image_preview.js"></script>
    <script src="/static/js/photo_paste.js"></script>
    <script src="/static/js/add.js"></script>
    <script src="/static/js/duplicate_file_warning.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // When coming back from update, force all thumbnails to re-fetch
            document.querySelectorAll('img.thumb').forEach(img => {
                const cleanSrc = img.src.split('?')[0];
                img.src = cleanSrc + '?v=' + Date.now();
            });
        });

        function openFileDirectly(filePath) {
            fetch('/open-file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ filePath: filePath })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to open file');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data.message);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to open file: ' + error.message);
                });
        }
    </script>

</body>

</html>